<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>


<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
    <script th:inline="javascript">

        var itemId = $('#itemId').val();

        $(document).ready(function(){
            fetchComments()
            $('#commentForm').on('submit', function(event) {
                event.preventDefault(); // Prevent the form from being submitted

                var commentText = $('#commentText').val();


                $.ajax({
                    url: '/comments/new',
                    type: 'POST',
                    data: {
                        'commentText': commentText,
                        'itemId': itemId
                    },
                    success: function() {
                        $('#commentText').val(''); // Clear the text area
                        fetchComments(); // Fetch the updated list of comments
                    },
                    error: function(error) {
                        console.log('Error in submitting comment');
                    }
                });
            });


        });



        function fetchComments() {

            var itemId = $('#itemId').val();

            $.ajax({
                url: '/comments/fetch/' + itemId,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    appendComments(data);
                },
                error: function(error) {
                    console.log('Error in fetching comments');
                }
            });
        }

        function appendComments(comments) {
            var commentsDiv = $('#commentsList');
            commentsDiv.empty(); // Clear out the existing comments

            $.each(comments, function(i, comment) {
                var commentDiv = `<div class="card mgb-15">
            <div class="card-body">
                <h5 class="card-title">${comment.item.itemNm}</h5>
                <p class="card-text">${comment.commentText}</p>
            </div>
        </div>`;

                commentsDiv.append(commentDiv);
            });
        }

    </script>
</th:block>



<div layout:fragment="content" style="margin-left:25%;margin-right:25%">

    <input type="hidden" id="itemId" th:value="${item.id}">

    <!-- Comments Section -->
    <div class="jumbotron jumbotron-fluid mgt-30">
        <div class="container">
            <h4 class="display-5">댓글</h4>
            <hr class="my-4">

            <!-- Existing Comments List -->
            <div id="commentsList" th:each="comment : ${comments}">
                <div class="card mgb-15">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${comment.getItem.itemNm}"></h5>
                        <h5 class="card-title" th:text="${comment.getItem.itemNm}"></h5>
                        <p class="card-text" th:text="${comment.commentText}"></p>
                        <!--                        <p class="card-text">-->
                        <!--                            <small class="text-muted" th:text="${comment.date}"></small>-->
                        <!--                        </p>-->
                    </div>
                </div>
            </div>

            <!-- New Comment Form -->
            <form id="commentForm"  th:action="@{/comments/new}" method="post" >
                <div class="form-group">
                    <label for="commentText">댓글 남기기:</label>
                    <textarea class="form-control" id="commentText" name="commentText" rows="3"></textarea>
                </div>
                <input type="hidden" id="itemId" name="itemId" th:value="${item.id}">
                <button type="submit" class="btn btn-primary">제출</button>
            </form>
        </div>
    </div>

</div>

</html>